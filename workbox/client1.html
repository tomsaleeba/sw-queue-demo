<!doctype html>
<html>

<head>
  <title>Service Worker - Client 1</title>
</head>

<body>
  <div>
    Service worker support = <span id="sw-support">(not checked yet)</span>
    <button onclick="refreshSwStatus()">Refresh</button>
    <button onclick="killSw()">Kill SW</button>
    (Note: reload the page to get the SW running again)
  </div>
  <div>
    <button onclick="doCreateObs()">Create observation</button>
  </div>
  <p>Status = <span id="the-status">(nothing yet)</span></p>
  <h1>Observations</h1>
  <div>
    <button onclick="refreshObs()">Refresh list</button>
  </div>
  <ul id="obs-list">
    <li>(empty)</li>
  </ul>
  <script>
    const endpointPrefix = 'http://localhost:3000/v1'
    const someJpg = new Blob(Uint8Array.from([0xFF, 0xD8, 0xFF, 0xDB]), {
      type: 'image/jpeg'
    })

    if ('serviceWorker' in navigator) {
      // Register service worker
      navigator.serviceWorker.register('/service-worker.js').then(function(reg) {
        console.log("SW registration succeeded. Scope is " + reg.scope)
      }).catch(function(err) {
        console.error("SW registration failed with error " + err)
      })

      navigator.serviceWorker.addEventListener('message', function(event) {
        console.log('Client 1 received message: ' + event.data)
        event.ports[0].postMessage('Client 1 says "hello back!"')
      })
    }

    function sendMessageToSw(msg) {
      return new Promise(function(resolve, reject) {
        const msgChan = new MessageChannel()
        msgChan.port1.onmessage = function(event) {
          if (event.data.error) {
            return reject(event.data.error)
          }
          return resolve(event.data)
        }
        const controller = navigator.serviceWorker.controller
        if (!controller) {
          return reject('No sw reference available. Either there is no active ' +
            'sw or you did a force refresh (shift + refresh)')
        }
        controller.postMessage('Client 1 says "' + msg +
          '"', [msgChan.port2])
      })
    }

    async function doCreateObs() {
      console.log('creating obs...')
      setStatus('processing...')
      const obs = {
        uniqueId: Date.now(),
        foo: 'bar'
      }
      const photo1 = {
        file: someJpg
      }
      const photo2 = {
        file: someJpg
      }
      const isNoSwSupport = !('serviceWorker' in navigator &&
        navigator.serviceWorker.controller)
      if (isNoSwSupport) {
        console.debug('No SW support, doing it all ourselves')
        try {
          const resp = await doPost('observations', JSON.stringify(obs))
          const obsId = (await resp.json()).obsId
          const formData1 = new FormData()
          formData1.append('file', photo1.file)
          formData1.append('obsId', obsId)
          await doPost('photos', formData1)
          formData2.append('file', photo2.file)
          formData2.append('obsId', obsId)
          await doPost('photos', formData2)
          setStatus('finished')
        } catch (err) {
          console.error('Failed to POST obs record', err)
          setStatus('error')
        }
        // FIXME need to also POST photos
        // FIXME need retry logic
        return
      }
      console.debug('We have SW support, POSTing bundle')
      const resp = await fetch('http://local.service-worker/queue/obs-bundle', {
        method: 'POST',
        // FIXME binary data is NOT going to like being stringified
        body: JSON.stringify({
          obs,
          photos: [photo1, photo2]
        })
      })
      if (resp.ok) {
        console.log('All requests queued for obs', JSON.stringify(await resp.json()))
        setStatus('finished')
        return
      }
      // our SW enqueue code failed
      // FIXME do we fallback to the "no service worker" approach, or retry?
      console.error(resp.statusText)
    }

    async function refreshObs() {
      console.debug('refreshing obs list...')
      const resp = await fetch(`${endpointPrefix}/observations`, {
        method: 'GET',
        mode: 'cors',
      })
      const obs = await resp.json()
      document.getElementById('obs-list').innerHTML = obs.reduce((accum, curr) => {
        accum += `<li>ID=${curr.id}, ${curr.photos.length} photos</li>`
        return accum
      }, '')
    }

    async function doPost(reqType, body) {
      try {
        const resp = await fetch(`${endpointPrefix}/${reqType}`, {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body
        })
        return resp
      } catch (err) {
        throw err
      }
    }

    function setStatus(status) {
      document.getElementById('the-status').innerText = status
    }

    function setSwStatus(msg) {
      document.getElementById('sw-support').innerText = msg
    }

    function refreshSwStatus() {
      console.debug('Checking SW support')
      if (!('serviceWorker' in navigator)) {
        setSwStatus('No. Not supported')
        return
      }
      if (!navigator.serviceWorker.controller) {
        setSwStatus('No. Not active')
        return
      }
      setSwStatus('Yes')
    }

    async function killSw() {
      console.debug('killing service worker')
      if ('serviceWorker' in navigator) {
        const registrations = await navigator.serviceWorker.getRegistrations()
        for (const registration of registrations) {
          await registration.unregister()
        }
        window.location.reload()
      }
    }

    refreshSwStatus()
  </script>
</body>

</html>
